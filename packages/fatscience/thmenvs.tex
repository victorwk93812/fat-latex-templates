\theoremstyle{definition}
% \theoremstyle{plain}

% Define the base theorem environment
\newtheorem{thmplain}{Theorem}[section]
\newtheorem*{thmplain*}{Theorem}
\newtheorem{custhmplain}{Theorem}[section]

% Colored version using same counter
\tcbuselibrary{theorems}
\NewTColorBox[use counter=thmplain]{thmboxed}{ o }{
    breakable,
    enhanced,
    colback=blue!5!white,
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Theorem~\thethmplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{thmboxed*}{ o }{
    breakable,
    enhanced,
    colback=blue!5!white,
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Theorem \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{custhmboxed}{ o o }{
    breakable,
    enhanced,
    colback=blue!5!white,
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Theorem~\IfNoValueTF{#2}{\thethmplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{thm}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{thmboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{thmplain}
        }
        {
            \begin{thmplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{thmboxed}}{\end{thmplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{thm*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{thmboxed*}[#3] % thmboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{thmplain*}
        }
        {
            \begin{thmplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{thmboxed*}}{\end{thmplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{custhm}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{custhmboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecusthmplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{custhmplain}
        }
        {
            \begin{custhmplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{custhmboxed}}{\end{custhmplain}}
}


% Lemma version
\newtheorem{lemplain}[thmplain]{Lemma}
\newtheorem*{lemplain*}{Lemma}
\newtheorem{cuslemplain}{Lemma}[section]

% Colored version using same counter
\NewTColorBox[use counter=thmplain]{lemboxed}{ o }{
    breakable,
    enhanced,
    colback=blue!5!white, 
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Lemma~\thethmplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{lemboxed*}{ o }{
    breakable,
    enhanced,
    colback=blue!5!white, 
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Lemma \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cuslemboxed}{ o o }{
    breakable,
    enhanced,
    colback=blue!5!white, 
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Lemma~\IfNoValueTF{#2}{\thethmplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{lem}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{lemboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{lemplain}
        }
        {
            \begin{lemplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{lemboxed}}{\end{lemplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{lem*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{lemboxed*}[#3] % lemboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{lemplain*}
        }
        {
            \begin{lemplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{lemboxed*}}{\end{lemplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cuslem}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cuslemboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecuslemplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cuslemplain}
        }
        {
            \begin{cuslemplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cuslemboxed}}{\end{cuslemplain}}
}

% Proposition version
\newtheorem{propplain}[thmplain]{Proposition}
\newtheorem*{propplain*}{Proposition}
\newtheorem{cuspropplain}{Proposition}[section]

% Colored version using same counter
\NewTColorBox[use counter=thmplain]{propboxed}{ o }{
    breakable,
    enhanced,
    colback=blue!5!white, 
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Proposition~\thethmplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{propboxed*}{ o }{
    breakable,
    enhanced,
    colback=blue!5!white, 
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Proposition \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cuspropboxed}{ o o }{
    breakable,
    enhanced,
    colback=blue!5!white, 
    colframe=blue!75!black,
    fonttitle=\bfseries,
    title={Proposition~\IfNoValueTF{#2}{\thethmplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{prop}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{propboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{propplain}
        }
        {
            \begin{propplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{propboxed}}{\end{propplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{prop*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{propboxed*}[#3] % propboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{propplain*}
        }
        {
            \begin{propplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{propboxed*}}{\end{propplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cusprop}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cuspropboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecuspropplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cuspropplain}
        }
        {
            \begin{cuspropplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cuspropboxed}}{\end{cuspropplain}}
}


% Corollary version
\newtheorem{corplain}[thmplain]{Corollary}
\newtheorem*{corplain*}{Corollary}
\newtheorem{cuscorplain}{Corollary}[section]

% Colored version using same counter
\NewTColorBox[use counter=thmplain]{corboxed}{ o }{
    breakable,
    enhanced,
    colback=purple!5!white, 
    colframe=purple!75!black,
    fonttitle=\bfseries,
    title={Corollary~\thethmplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{corboxed*}{ o }{
    breakable,
    enhanced,
    colback=purple!5!white, 
    colframe=purple!75!black,
    fonttitle=\bfseries,
    title={Corollary \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cuscorboxed}{ o o }{
    breakable,
    enhanced,
    colback=purple!5!white, 
    colframe=purple!75!black,
    fonttitle=\bfseries,
    title={Corollary~\IfNoValueTF{#2}{\thethmplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{cor}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{corboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{corplain}
        }
        {
            \begin{corplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{corboxed}}{\end{corplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{cor*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{corboxed*}[#3] % corboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{corplain*}
        }
        {
            \begin{corplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{corboxed*}}{\end{corplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cuscor}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cuscorboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecuscorplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cuscorplain}
        }
        {
            \begin{cuscorplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cuscorboxed}}{\end{cuscorplain}}
}


% Definition version
\newtheorem{dfnplain}{Definition}[section]
\newtheorem*{dfnplain*}{Definition}
\newtheorem{cusdfnplain}{Definition}[section]

% Colored version using same counter
\NewTColorBox[use counter=dfnplain]{dfnboxed}{ o }{
    breakable,
    enhanced,
    colback=green!5!white, 
    colframe=green!75!black,
    fonttitle=\bfseries,
    title={Definition~\thedfnplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{dfnboxed*}{ o }{
    breakable,
    enhanced,
    colback=green!5!white, 
    colframe=green!75!black,
    fonttitle=\bfseries,
    title={Definition \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cusdfnboxed}{ o o }{
    breakable,
    enhanced,
    colback=green!5!white, 
    colframe=green!75!black,
    fonttitle=\bfseries,
    title={Definition~\IfNoValueTF{#2}{\thedfnplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{dfn}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{dfnboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{dfnplain}
        }
        {
            \begin{dfnplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{dfnboxed}}{\end{dfnplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{dfn*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{dfnboxed*}[#3] % dfnboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{dfnplain*}
        }
        {
            \begin{dfnplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{dfnboxed*}}{\end{dfnplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cusdfn}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cusdfnboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecusdfnplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cusdfnplain}
        }
        {
            \begin{cusdfnplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cusdfnboxed}}{\end{cusdfnplain}}
}


% Example version
\newtheorem{exmpplain}{Example}[section]
\newtheorem*{exmpplain*}{Example}
\newtheorem{cusexmpplain}{Example}[section]

% Colored version using same counter
\NewTColorBox[use counter=exmpplain]{exmpboxed}{ o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Example~\theexmpplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{exmpboxed*}{ o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Example \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cusexmpboxed}{ o o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Example~\IfNoValueTF{#2}{\theexmpplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{exmp}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{exmpboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{exmpplain}
        }
        {
            \begin{exmpplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{exmpboxed}}{\end{exmpplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{exmp*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{exmpboxed*}[#3] % exmpboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{exmpplain*}
        }
        {
            \begin{exmpplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{exmpboxed*}}{\end{exmpplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cusexmp}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cusexmpboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecusexmpplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cusexmpplain}
        }
        {
            \begin{cusexmpplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cusexmpboxed}}{\end{cusexmpplain}}
}


% Exercise version
\newtheorem{exerplain}{Exercise}[section]
\newtheorem*{exerplain*}{Exercise}
\newtheorem{cusexerplain}{Exercise}[section]

% Colored version using same counter
\NewTColorBox[use counter=exerplain]{exerboxed}{ o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Exercise~\theexerplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{exerboxed*}{ o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Exercise \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cusexerboxed}{ o o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Exercise~\IfNoValueTF{#2}{\theexerplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{exer}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{exerboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{exerplain}
        }
        {
            \begin{exerplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{exerboxed}}{\end{exerplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{exer*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{exerboxed*}[#3] % exerboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{exerplain*}
        }
        {
            \begin{exerplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{exerboxed*}}{\end{exerplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cusexer}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cusexerboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecusexerplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cusexerplain}
        }
        {
            \begin{cusexerplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cusexerboxed}}{\end{cusexerplain}}
}


% Problem version
\newtheorem{probplain}[exerplain]{Problem}
\newtheorem*{probplain*}{Problem}
\newtheorem{cusprobplain}{Problem}[section]

% Colored version using same counter
\NewTColorBox[use counter=exerplain]{probboxed}{ o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Problem~\theexerplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{probboxed*}{ o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Problem \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cusprobboxed}{ o o }{
    breakable,
    enhanced,
    colback=yellow!5!white, 
    colframe=yellow!75!black,
    fonttitle=\bfseries,
    title={Problem~\IfNoValueTF{#2}{\theexerplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{prob}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{probboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{probplain}
        }
        {
            \begin{probplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{probboxed}}{\end{probplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{prob*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{probboxed*}[#3] % probboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{probplain*}
        }
        {
            \begin{probplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{probboxed*}}{\end{probplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cusprob}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cusprobboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecusprobplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cusprobplain}
        }
        {
            \begin{cusprobplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cusprobboxed}}{\end{cusprobplain}}
}


% Remark version
\newtheorem{remplain}{Remark}[section]
\newtheorem*{remplain*}{Remark}
\newtheorem{cusremplain}{Remark}[section]

% Colored version using same counter
\NewTColorBox[use counter=remplain]{remboxed}{ o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Remark~\theremplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{remboxed*}{ o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Remark \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cusremboxed}{ o o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Remark~\IfNoValueTF{#2}{\theremplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{rem}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{remboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{remplain}
        }
        {
            \begin{remplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{remboxed}}{\end{remplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{rem*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{remboxed*}[#3] % remboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{remplain*}
        }
        {
            \begin{remplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{remboxed*}}{\end{remplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cusrem}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cusremboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecusremplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cusremplain}
        }
        {
            \begin{cusremplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cusremboxed}}{\end{cusremplain}}
}


% Claim version
\newtheorem{clmplain}{Claim}
\newtheorem*{clmplain*}{Claim}
\newtheorem{cusclmplain}{Claim}[section]

% Colored version using same counter
\NewTColorBox[use counter=clmplain]{clmboxed}{ o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Claim~\theclmplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{clmboxed*}{ o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Claim \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cusclmboxed}{ o o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Claim~\IfNoValueTF{#2}{\theclmplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{clm}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{clmboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{clmplain}
        }
        {
            \begin{clmplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{clmboxed}}{\end{clmplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{clm*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{clmboxed*}[#3] % clmboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{clmplain*}
        }
        {
            \begin{clmplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{clmboxed*}}{\end{clmplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cusclm}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cusclmboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecusclmplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cusclmplain}
        }
        {
            \begin{cusclmplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cusclmboxed}}{\end{cusclmplain}}
}

% Solution version
\newtheorem{solplain}{Solution}
\newtheorem*{solplain*}{Solution}
\newtheorem{cussolplain}{Solution}[section]

% Colored version using same counter
\NewTColorBox[use counter=solplain]{solboxed}{ o }{
    breakable,
    enhanced,
    colback=orange!5!white, 
    colframe=orange!75!black,
    fonttitle=\bfseries,
    title={Solution~\thesolplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{solboxed*}{ o }{
    breakable,
    enhanced,
    colback=orange!5!white, 
    colframe=orange!75!black,
    fonttitle=\bfseries,
    title={Solution \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cussolboxed}{ o o }{
    breakable,
    enhanced,
    colback=orange!5!white, 
    colframe=orange!75!black,
    fonttitle=\bfseries,
    title={Solution~\IfNoValueTF{#2}{\thesolplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{sol}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{solboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{solplain}
        }
        {
            \begin{solplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{solboxed}}{\end{solplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{sol*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{solboxed*}[#3] % solboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{solplain*}
        }
        {
            \begin{solplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{solboxed*}}{\end{solplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cussol}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cussolboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecussolplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cussolplain}
        }
        {
            \begin{cussolplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cussolboxed}}{\end{cussolplain}}
}

% Notation version
\newtheorem{ntnplain}{Notation}
\newtheorem*{ntnplain*}{Notation}
\newtheorem{cusntnplain}{Notation}[section]

% Colored version using same counter
\NewTColorBox[use counter=ntnplain]{ntnboxed}{ o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Notation~\thentnplain \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{ntnboxed*}{ o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Notation \IfNoValueTF{#1}{}{ (#1)}}
}
\NewTColorBox[no counter]{cusntnboxed}{ o o }{
    breakable,
    enhanced,
    colback=red!5!white, 
    colframe=red!75!black,
    fonttitle=\bfseries,
    title={Notation~\IfNoValueTF{#2}{\thentnplain}{#2} \IfNoValueTF{#1}{}{ (#1)}}
}

% Numbered theorem with options: linebreak, fancy, title
\NewDocumentEnvironment{ntn}{ t* t! o }
{
    \IfBooleanTF{#2}
    { 
        \begin{ntnboxed}[#3] 
    }
    { 
        \IfNoValueTF{#3}
        {
            \begin{ntnplain}
        }
        {
            \begin{ntnplain}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{ntnboxed}}{\end{ntnplain}}
}

% Unnumbered version with optional linebreak, fancy, and title
\NewDocumentEnvironment{ntn*}{ t* t! o }
{
    \IfBooleanTF{#2}
    {
        \begin{ntnboxed*}[#3] % ntnboxed already uses the counter; we’ll hide it manually
    }
    {
        \IfNoValueTF{#3}
        {
            \begin{ntnplain*}
        }
        {
            \begin{ntnplain*}[#3]
        }
    }
    \IfBooleanTF{#1}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#2}{\end{ntnboxed*}}{\end{ntnplain*}}
}

% Custom-numbered version with optional linebreak and fancy, and title
\NewDocumentEnvironment{cusntn}{ m t* t! o }
{
    \IfBooleanTF{#3}
    { 
        \begin{cusntnboxed}[#4][#1] 
    }
    {
        \renewcommand{\thecusntnplain}{#1} 
        \IfNoValueTF{#4}
        {
            \begin{cusntnplain}
        }
        {
            \begin{cusntnplain}[#4]
        }
    }
    \IfBooleanTF{#2}{\leavevmode\par}{}
}
{
    \IfBooleanTF{#3}{\end{cusntnboxed}}{\end{cusntnplain}}
}

\renewcommand{\thethmplain}{\thesection.\arabic{thmplain}}
\renewcommand{\thelemplain}{\thesection.\arabic{lemplain}}
\renewcommand{\thepropplain}{\thesection.\arabic{propplain}}
\renewcommand{\thecorplain}{\thesection.\arabic{corplain}}
\renewcommand{\thedfnplain}{\thesection.\arabic{dfnplain}}
\renewcommand{\theexmpplain}{\thesection.\arabic{exmpplain}}
\renewcommand{\theexerplain}{\thesection.\arabic{exerplain}}
\renewcommand{\theprobplain}{\thesection.\arabic{probplain}}
\renewcommand{\theremplain}{\thesection.\arabic{remplain}}
